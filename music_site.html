<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #121212;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1db954;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .search-section {
            padding: 20px;
            background: #181818;
            border-bottom: 1px solid #282828;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-container input {
            flex: 1;
            padding: 12px;
            border: 1px solid #404040;
            border-radius: 24px;
            background: #282828;
            color: #fff;
            font-size: 14px;
        }

        .search-container input:focus {
            outline: none;
            border-color: #1db954;
            background: #333333;
        }

        .search-container button {
            padding: 12px 24px;
            background: #1db954;
            border: none;
            border-radius: 24px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .search-container button:hover {
            background: #1ed760;
        }

        .search-container button:disabled {
            background: #404040;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #282828;
            border: 1px solid #404040;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #404040;
        }

        .filter-btn.active {
            background: #1db954;
            border-color: #1db954;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        .results-section {
            flex: 1;
            min-width: 0;
        }

        .player-section {
            width: 350px;
            background: #181818;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #282828;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .results-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1db954;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .track-card {
            background: #282828;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #404040;
        }

        .track-card:hover {
            background: #333333;
            border-color: #1db954;
        }

        .track-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            background: #404040;
            border-radius: 4px;
            margin-bottom: 12px;
            overflow: hidden;
            object-fit: cover;
        }

        .track-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 12px;
            color: #b3b3b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-section h2 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #1db954;
        }

        .player-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            background: #404040;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            object-fit: cover;
        }

        .player-info {
            margin-bottom: 20px;
        }

        .player-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .player-artist {
            font-size: 13px;
            color: #b3b3b3;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .player-duration {
            font-size: 12px;
            color: #b3b3b3;
        }

        .player-controls {
            margin-bottom: 20px;
        }

        .time-display {
            font-size: 12px;
            color: #b3b3b3;
            text-align: center;
            margin-bottom: 8px;
        }

        #progress {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            margin-bottom: 15px;
            cursor: pointer;
            accent-color: #1db954;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: space-between;
        }

        .control-btn {
            flex: 1;
            padding: 10px;
            background: #282828;
            border: 1px solid #404040;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .control-btn:hover:not(:disabled) {
            background: #333333;
            border-color: #1db954;
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .control-btn.primary {
            background: #1db954;
            border-color: #1db954;
            font-weight: 600;
        }

        .control-btn.primary:hover {
            background: #1ed760;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-control label {
            font-size: 12px;
            color: #b3b3b3;
            min-width: 40px;
        }

        #volume {
            flex: 1;
            height: 4px;
            cursor: pointer;
            accent-color: #1db954;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #b3b3b3;
        }

        .error-message {
            background: #ff4444;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #1db954;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #b3b3b3;
        }

        .suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .suggestion-btn {
            padding: 6px 12px;
            background: #282828;
            border: 1px solid #404040;
            color: #b3b3b3;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .suggestion-btn:hover {
            background: #333333;
            color: #fff;
        }

        @media (max-width: 1000px) {
            .content {
                flex-direction: column;
            }

            .player-section {
                width: 100%;
                position: static;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 20px;
            }

            .search-container {
                flex-direction: column;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .player-section {
                padding: 15px;
            }
        }

        .chart-container {
            margin-bottom: 40px;
        }

        .home-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1db954;
        }

        .horizontal-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .horizontal-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .horizontal-scroll::-webkit-scrollbar-track {
            background: #282828;
            border-radius: 4px;
        }

        .horizontal-scroll::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .horizontal-scroll::-webkit-scrollbar-thumb:hover {
            background: #1db954;
        }

        .small-track-card {
            background: #282828;
            border-radius: 8px;
            padding: 10px;
            min-width: 150px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #404040;
        }

        .small-track-card:hover {
            background: #333333;
            border-color: #1db954;
        }

        .small-track-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            background: #404040;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
            object-fit: cover;
        }

        .small-track-title {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
        }

        .small-track-artist {
            font-size: 11px;
            color: #b3b3b3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #282828;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #b3b3b3;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #fff;
        }

        .tab-btn.active {
            color: #1db954;
            border-bottom-color: #1db954;
        }

        .content > div {
            display: none;
        }

        .content > div.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽµ Music Player</h1>
    </div>

    <div class="search-section">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search songs, artists, albums...">
            <button onclick="search()">Search</button>
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="setFilter('songs')">Songs</button>
            <button class="filter-btn" onclick="setFilter('videos')">Videos</button>
            <button class="filter-btn" onclick="setFilter('albums')">Albums</button>
            <button class="filter-btn" onclick="setFilter('artists')">Artists</button>
            <button class="filter-btn" onclick="setFilter('playlists')">Playlists</button>
        </div>
        <div class="suggestions" id="suggestions"></div>
    </div>

    <div class="content">
        <div id="searchTab" class="active">
            <div class="results-section">
                <div id="searchResults"></div>
            </div>
        </div>

        <div id="homeTab">
            <div class="results-section">
                <div id="homeResults"></div>
            </div>
        </div>

        <div class="player-section">
            <h2>Now Playing</h2>
            <img id="playerThumbnail" class="player-thumbnail" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Crect fill='%23404040' width='300' height='300'/%3E%3C/svg%3E" alt="Track thumbnail">
            <div class="player-info">
                <div class="player-title" id="playerTitle">No track selected</div>
                <div class="player-artist" id="playerArtist">-</div>
                <div class="player-duration" id="playerDuration">0:00</div>
            </div>
            <div class="player-controls">
                <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
                <input type="range" id="progress" min="0" max="100" value="0" disabled>
            </div>
            <div class="control-buttons">
                <button class="control-btn" id="playPause" onclick="togglePlay()" disabled>Play</button>
                <button class="control-btn" id="mute" onclick="toggleMute()" disabled>Mute</button>
            </div>
            <div class="volume-control">
                <label for="volume">Volume</label>
                <input type="range" id="volume" min="0" max="100" value="100" disabled>
            </div>
        </div>
    </div>

    <div id="player"></div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let currentFilter = 'songs';
        let player;
        let interval;
        let isMuted = false;
        let previousVolume = 100;
        let currentTrack = null;

        // Load YouTube API
        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            console.log('YouTube API Ready');
        }

        // Initialize player and load home on page load
        window.addEventListener('load', () => {
            loadHome();
        });

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function getSuggestions(query) {
            if (!query || query.length < 2) {
                document.getElementById('suggestions').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/search/suggestions?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const suggestions = data.suggestions || [];
                const suggestionsHtml = suggestions.slice(0, 5).map(s => 
                    `<button class="suggestion-btn" onclick="setSearchAndSearch('${s.replace(/'/g, "\\'")}')">
                        ${escapeHtml(s)}
                    </button>`
                ).join('');
                
                document.getElementById('suggestions').innerHTML = suggestionsHtml;
            } catch (error) {
                console.error('Error getting suggestions:', error);
            }
        }

        function setSearchAndSearch(query) {
            document.getElementById('searchInput').value = query;
            search();
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            getSuggestions(e.target.value);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                search();
            }
        });

        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showMessage('Please enter a search query', 'error');
                return;
            }

            showTab('searchTab');
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const endpoint = currentFilter === 'songs' ? 'search/songs' : 
                                currentFilter === 'videos' ? 'search/videos' :
                                currentFilter === 'albums' ? 'search/albums' :
                                currentFilter === 'artists' ? 'search/artists' :
                                currentFilter === 'playlists' ? 'search/playlists' : 'search';

                const url = `${API_BASE}/${endpoint}?query=${encodeURIComponent(query)}&limit=30`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                displayResults(data, resultsDiv);
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        function displayResults(data, container) {
            // Handle different data structures
            let results = [];
            
            if (Array.isArray(data)) {
                results = data;
            } else if (data.results) {
                results = data.results;
            } else if (data[currentFilter]) {
                results = data[currentFilter];
            }

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="no-results">No results found</div>';
                return;
            }

            const html = results.map(item => {
                const thumbnail = item.thumbnail || item.thumbnails?.[0] || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22180%22 height=%22180%22%3E%3Crect fill=%22%23404040%22 width=%22180%22 height=%22180%22/%3E%3C/svg%3E';
                const title = escapeHtml(item.title || item.name || 'Unknown');
                const artist = escapeHtml(item.artists?.[0]?.name || item.artist || 'Unknown Artist');
                const videoId = item.videoId || item.id;
                const browseId = item.browseId || item.browse_id;

                return `
                    <div class="track-card" onclick="playTrack('${videoId}', '${title}', '${artist}', '${thumbnail}')">
                        <img src="${thumbnail}" alt="${title}" class="track-thumbnail" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22180%22 height=%22180%22%3E%3Crect fill=%22%23404040%22 width=%22180%22 height=%22180%22/%3E%3C/svg%3E'">
                        <div class="track-title">${title}</div>
                        <div class="track-artist">${artist}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="results-header">Results (${results.length})</div>
                <div class="results-grid">
                    ${html}
                </div>
            `;
        }

        async function loadHome() {
            showTab('homeTab');
            const homeDiv = document.getElementById('homeResults');
            homeDiv.innerHTML = '<div class="loading">Loading recommendations...</div>';

            try {
                const response = await fetch(`${API_BASE}/home?limit=20`);
                if (!response.ok) throw new Error('Failed to load home');
                
                const data = await response.json();
                displayHome(data, homeDiv);
            } catch (error) {
                console.error('Home error:', error);
                homeDiv.innerHTML = `<div class="error-message">Error loading recommendations</div>`;
            }
        }

        function displayHome(data, container) {
            let sections = [];

            // Parse home data
            if (Array.isArray(data)) {
                sections = data.map((section, idx) => ({
                    title: section.title || section.section_title || `Recommendations ${idx + 1}`,
                    items: Array.isArray(section) ? section : section.contents || section.items || []
                }));
            } else if (data.sections) {
                sections = data.sections;
            }

            let html = '';
            sections.forEach(section => {
                const items = Array.isArray(section) ? section : (section.items || section.contents || []);
                
                if (!items || items.length === 0) return;

                html += `<div class="home-section">
                    <div class="section-title">${escapeHtml(section.title || 'Recommendations')}</div>
                    <div class="horizontal-scroll">
                        ${items.map(item => {
                            const thumbnail = item.thumbnail || item.thumbnails?.[0] || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22%3E%3Crect fill=%22%23404040%22 width=%22150%22 height=%22150%22/%3E%3C/svg%3E';
                            const title = escapeHtml(item.title || item.name || 'Unknown');
                            const artist = escapeHtml(item.artists?.[0]?.name || item.artist || 'Unknown Artist');
                            const videoId = item.videoId || item.id;

                            if (!videoId) return '';

                            return `
                                <div class="small-track-card" onclick="playTrack('${videoId}', '${title}', '${artist}', '${thumbnail}')">
                                    <img src="${thumbnail}" alt="${title}" class="small-track-thumbnail" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22%3E%3Crect fill=%22%23404040%22 width=%22150%22 height=%22150%22/%3E%3C/svg%3E'">
                                    <div class="small-track-title">${title}</div>
                                    <div class="small-track-artist">${artist}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>`;
            });

            if (!html) {
                html = '<div class="no-results">No recommendations available</div>';
            }

            container.innerHTML = html;
        }

        function playTrack(videoId, title, artist, thumbnail) {
            if (!videoId || videoId === 'undefined') {
                showMessage('Cannot play this track', 'error');
                return;
            }

            currentTrack = { videoId, title, artist, thumbnail };
            
            // Update player display
            document.getElementById('playerTitle').textContent = title;
            document.getElementById('playerArtist').textContent = artist;
            document.getElementById('playerThumbnail').src = thumbnail;
            document.getElementById('playerThumbnail').onerror = function() {
                this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect fill=%22%23404040%22 width=%22300%22 height=%22300%22/%3E%3C/svg%3E';
            };

            // Initialize or reload player
            if (player) {
                player.loadVideoById(videoId);
            } else {
                player = new YT.Player('player', {
                    height: '0',
                    width: '0',
                    videoId: videoId,
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
            }

            showMessage(`Now playing: ${title}`, 'success');
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            document.getElementById('playPause').disabled = false;
            document.getElementById('mute').disabled = false;
            document.getElementById('volume').disabled = false;
            document.getElementById('progress').disabled = false;
            setVolume();
            updateTimeAndProgress();
            clearInterval(interval);
            interval = setInterval(updateTimeAndProgress, 1000);
        }

        function onPlayerStateChange(event) {
            const button = document.getElementById('playPause');
            if (event.data === YT.PlayerState.PLAYING) {
                button.textContent = 'Pause';
            } else {
                button.textContent = 'Play';
            }
        }

        function onPlayerError(event) {
            let errorMsg = 'Error loading video';
            if (event.data === 150 || event.data === 151) {
                errorMsg = 'Video is restricted (copyright/embedding disabled)';
            } else if (event.data === 2) {
                errorMsg = 'Invalid video ID';
            }
            showMessage(errorMsg, 'error');
        }

        function togglePlay() {
            if (!player) return;
            if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function toggleMute() {
            if (!player) return;
            isMuted = !isMuted;
            if (isMuted) {
                previousVolume = player.getVolume();
                player.setVolume(0);
                document.getElementById('mute').textContent = 'Unmute';
                document.getElementById('volume').value = 0;
            } else {
                player.setVolume(previousVolume);
                document.getElementById('mute').textContent = 'Mute';
                document.getElementById('volume').value = previousVolume;
            }
        }

        function setVolume() {
            if (!player) return;
            const volume = document.getElementById('volume').value;
            player.setVolume(volume);
            if (volume > 0) {
                isMuted = false;
                previousVolume = volume;
                document.getElementById('mute').textContent = 'Mute';
            } else {
                isMuted = true;
                document.getElementById('mute').textContent = 'Unmute';
            }
        }

        document.getElementById('volume').addEventListener('input', setVolume);
        document.getElementById('progress').addEventListener('input', seekVideo);

        function seekVideo() {
            if (!player) return;
            const progress = document.getElementById('progress').value;
            const duration = player.getDuration();
            player.seekTo((progress / 100) * duration, true);
        }

        function updateTimeAndProgress() {
            if (!player || !player.getDuration) return;
            
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            const progress = (currentTime / duration) * 100 || 0;
            
            document.getElementById('progress').value = progress;
            document.getElementById('timeDisplay').textContent = formatTime(currentTime) + ' / ' + formatTime(duration);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function showTab(tabName) {
            document.querySelectorAll('.content > div').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        function showMessage(msg, type = 'error') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = msg;
            
            const searchSection = document.querySelector('.search-section');
            searchSection.insertBefore(messageDiv, searchSection.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
